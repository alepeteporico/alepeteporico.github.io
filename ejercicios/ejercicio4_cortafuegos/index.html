<!DOCTYPE html>
<html>

    <head>
        <title> Ejercicio 4 cortafuegos &middot; Alepetepórico Blog </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.80.0" />




<script src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">


<link rel="stylesheet" href="https://alepeteporico.github.io/css/nix.css">



<link rel="shortcut icon" href="/favicon.ico">



<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">






    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
      <a class="navbar-brand" id="green-terminal" href='https://alepeteporico.github.io/'>
        blog@alepetepórico ~ $
      </a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href='https://alepeteporico.github.io/'>/home/blog</a>
        </li>
        
				
				
				<li class="dropdown">
                    
            		<a href="https://alepeteporico.github.io/apuntes">~/apuntes</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://alepeteporico.github.io/ejercicios">~/ejercicios</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://alepeteporico.github.io/problemas">~/problemas</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://alepeteporico.github.io/practicas">~/prácticas</a>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="flex-wrapper">
            <div class="container wrapper">
                <h1><a href="https://alepeteporico.github.io/ejercicios/ejercicio4_cortafuegos/">Ejercicio 4 cortafuegos</a></h1>
                <span class="post-date">2022-03-11 </span>
                <div class="post-content">
                    <ul>
<li>
<p>Realizaremos las mismas reglas que en el ejercicio 3, ahora en nftables, para ello usaremos como hicimos el ejercicio 2 la familia inet sobre las tablas de nftables para que valgan tanto para ipv4 como para ipv6. Hagamos las tabalas y cadenas necesarias para empezar.</p>
</li>
<li>
<p>Añadimos una regla para tener conexión ssh con la máquina.</p>
</li>
</ul>
<pre><code>nft add rule inet filter input ip saddr 192.168.1.0/24 tcp dport 22 ct state new,established counter accept
nft add rule inet filter output ip daddr 192.168.1.0/24 tcp sport 22 ct state established counter accept
</code></pre><ul>
<li>Y la regla SNAT para que la LAN tenga acceso a internet.</li>
</ul>
<pre><code>nft add rule inet nat postrouting oifname &quot;ens3&quot; ip saddr 172.16.0.200/16 counter masquerade
</code></pre><ul>
<li>Ahora podemos crear la tabla y las reglas para hacer una politica DROP.</li>
</ul>
<pre><code>nft add table inet filter
nft add table inet nat
nft add chain inet filter input { type filter hook input priority 0 \; counter \; policy drop \; }
nft add chain inet filter output { type filter hook output priority 0 \; counter \; policy drop \; }
nft add chain inet filter forward { type filter hook forward priority 0 \; counter \; policy drop \; }
nft add chain inet nat prerouting { type nat hook prerouting priority 0 \; }
nft add chain inet nat postrouting { type nat hook postrouting priority 100 \; }
</code></pre><ul>
<li>También debemos permitir el tráfico de la loopback.</li>
</ul>
<pre><code>nft add rule inet filter input iifname &quot;lo&quot; counter accept    
nft add rule inet filter output oifname &quot;lo&quot; counter accept
</code></pre><ul>
<li>Permitimos hacer ping desde el exterior a las dos interfaces.</li>
</ul>
<pre><code>nft add rule inet filter input iifname &quot;ens3&quot; icmp type echo-request counter accept
nft add rule inet filter output oifname &quot;ens3&quot; icmp type echo-reply counter accept

nft add rule inet filter input iifname &quot;ens8&quot; icmp type echo-request counter accept
nft add rule inet filter output oifname &quot;ens8&quot; icmp type echo-reply counter accept
</code></pre><pre><code>alejandrogv@AlejandroGV:~$ ping 192.168.1.33
PING 192.168.1.33 (192.168.1.33) 56(84) bytes of data.
64 bytes from 192.168.1.33: icmp_seq=1 ttl=64 time=0.614 ms
^C
--- 192.168.1.33 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.614/0.614/0.614/0.000 ms
alejandrogv@AlejandroGV:~$ ping 192.16.0.1
PING 192.16.0.1 (192.16.0.1) 56(84) bytes of data.
64 bytes from 192.16.0.1: icmp_seq=1 ttl=58 time=7.79 ms
^C
--- 192.16.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 7.793/7.793/7.793/0.000 ms
</code></pre><ul>
<li>Permitir hacer ping desde la LAN.</li>
</ul>
<pre><code>nft add rule inet filter input iifname &quot;ens8&quot; icmp type echo-reply counter accept
nft add rule inet filter output oifname &quot;ens8&quot; icmp type echo-request counter accept
</code></pre><ul>
<li>Se permitirán hacer consultas DNS unicamente al servidor 192.168.202.2</li>
</ul>
<pre><code>nft add rule inet filter output oifname &quot;ens3&quot; ip daddr 192.168.202.2/32 udp dport 53 ct state new,established counter accept
nft add rule inet filter input iifname &quot;ens3&quot; ip saddr 192.168.202.2/32 udp sport 53 ct state established counter accept
</code></pre><pre><code>root@servidor:~# dig @192.168.202.2 www.google.es

; &lt;&lt;&gt;&gt; DiG 9.16.22-Debian &lt;&lt;&gt;&gt; www.google.es
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 52486
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;www.google.es.			IN	A

;; ANSWER SECTION:
www.google.es.		210	IN	A	142.250.201.67

;; Query time: 0 msec
;; SERVER: 192.168.202.2#53(192.168.202.2)
;; WHEN: Mon Mar 14 13:00:46 UTC 2022
;; MSG SIZE  rcvd: 344
</code></pre><ul>
<li>Permitimos la conexión a nuestro servidor web de la red interna desde el exterior.</li>
</ul>
<pre><code>nft add rule inet nat prerouting iifname &quot;ens3&quot; tcp dport 80 counter dnat ip to 172.16.0.200
nft add rule inet filter forward iifname &quot;ens3&quot; oifname &quot;ens8&quot; ip daddr 172.16.0.0/16 tcp dport 80 ct state new,established counter accept
nft add rule inet filter forward iifname &quot;ens8&quot; oifname &quot;ens3&quot; ip saddr 172.16.0.0/16 tcp sport 80 ct state established counter accept
</code></pre><ul>
<li>Permitimos hacer conexiones ssh desde la máquina del cortafeugos al exterior.</li>
</ul>
<pre><code>nft add rule inet filter output oifname &quot;ens3&quot; tcp dport 22 ct state new,established counter accept
nft add rule inet filter input iifname &quot;ens3&quot; tcp sport 22 ct state established counter accept
</code></pre><pre><code>root@debian:~# ssh debian@192.168.1.139
debian@192.168.1.139's password: 
Linux zeus 5.10.0-11-amd64 #1 SMP Debian 5.10.92-1 (2022-01-18) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Mon Mar 14 13:12:06 2022
</code></pre><ul>
<li>Permitimos que la máquina cortafuegos pueda navergar por internet.</li>
</ul>
<pre><code>nft add rule inet filter output oifname &quot;ens3&quot; tcp dport 80 ct state new,established counter accept
nft add rule inet filter input iifname &quot;ens3&quot; tcp sport 80 ct state established counter accept
nft add rule inet filter output oifname &quot;ens3&quot; tcp dport 443 ct state new,established counter accept
nft add rule inet filter input iifname &quot;ens3&quot; tcp sport 443 ct state established counter accept
</code></pre><ul>
<li>Permitiremos hacer ssh desde el cortafuegos a la LAN.</li>
</ul>
<pre><code>nft add rule inet filter output oifname &quot;ens8&quot; tcp dport 22 ct state new,established counter accept
nft add rule inet filter input iifname &quot;ens8&quot; tcp sport 22 ct state established counter accept
</code></pre><pre><code>root@debian:~# ssh hera@172.16.0.200
hera@172.16.0.200's password: 
Activate the web console with: systemctl enable --now cockpit.socket

Last login: Fri Mar 11 04:18:48 2022
[hera@hera ~]$ 
</code></pre><ul>
<li>Permitimos hacer ping desde la LAN al cortafuegos.</li>
</ul>
<pre><code>nft add rule inet filter output oifname &quot;ens8&quot; icmp type echo-reply counter accept
nft add rule inet filter input iifname &quot;ens8&quot; icmp type echo-request counter accept
</code></pre><pre><code>[hera@hera ~]$ ping 192.168.1.33
PING 192.168.1.33 (192.168.1.33) 56(84) bytes of data.
64 bytes from 192.168.1.33: icmp_seq=1 ttl=64 time=0.536 ms
^C
--- 192.168.1.33 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.536/0.536/0.536/0.000 ms
</code></pre><ul>
<li>Permitiremos que los equipos de la LAN puedan hacer ssh.</li>
</ul>
<pre><code>nft add rule inet filter output oifname &quot;ens8&quot; tcp sport 22 ct state established counter accept
nft add rule inet filter input iifname &quot;ens8&quot; tcp dport 22 ct state new,established counter accept
nft add rule inet filter forward iifname &quot;ens8&quot; oifname &quot;ens3&quot; tcp dport 22 ct state new,established counter accept
nft add rule inet filter forward iifname &quot;ens3&quot; oifname &quot;ens8&quot; tcp sport 22 ct state established counter accept
</code></pre><pre><code>[hera@hera ~]$ ssh usuario@192.168.1.33
usuario@192.168.1.33's password: 
Linux debian 5.10.0-12-amd64 #1 SMP Debian 5.10.103-1 (2022-03-07) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Fri Mar 11 12:35:40 2022 from 192.168.1.54
</code></pre><ul>
<li>Instalaremos un servidor de correo en la LAN y permitiremos su acceso desde el exterior y desde la máquina cortafuegos.</li>
</ul>
<pre><code>nft add rule inet filter output oifname &quot;ens8&quot; tcp dport 25 ct state new,established counter accept
nft add rule inet filter input iifname &quot;ens8&quot; tcp sport 25 ct state established counter accept
</code></pre><ul>
<li>Para que esto funcione también debemos crear una regla DNAT sino no funcionará desde el exterior.</li>
</ul>
<pre><code>nft add rule inet nat prerouting iifname &quot;ens3&quot; tcp dport 25 counter dnat ip to 172.16.0.200
nft add rule inet filter forward iifname &quot;ens3&quot; oifname &quot;ens8&quot; ip daddr 172.16.0.0/16 tcp dport 25 ct state new,established counter accept
nft add rule inet filter forward iifname &quot;ens8&quot; oifname &quot;ens3&quot; ip saddr 172.16.0.0/16 tcp sport 25 ct state established counter accept
</code></pre><pre><code>root@debian:~# telnet 172.16.0.200 25
Trying 172.16.0.200...
Connected to 172.16.0.200
Escape character is '^]'.
220 hera ESMTP Postfix (Debian/GNU)
HELO hera
250 hera

</code></pre><pre><code>alejandrogv@AlejandroGV:~$ telnet 172.16.0.200 25
Trying 172.16.0.200...
Connected to 172.16.0.200
Escape character is '^]'.
220 hera ESMTP Postfix (Debian/GNU)
HELO hera
250 hera

</code></pre><ul>
<li>Permitiremos las conexiones ssh desde exterior a la LAN.</li>
</ul>
<pre><code>nft add rule inet nat prerouting iifname &quot;ens3&quot; tcp dport 22 counter dnat ip to 172.16.0.200
nft add rule inet filter forward iifname &quot;ens3&quot; oifname &quot;ens8&quot; ip daddr 172.16.0.0/16 tcp dport 22 ct state new,established counter accept
nft add rule inet filter forward iifname &quot;ens8&quot; oifname &quot;ens3&quot; ip saddr 172.16.0.0/16 tcp sport 22 ct state established counter accept
</code></pre><pre><code>alejandrogv@AlejandroGV:~$ ssh hera@172.16.0.200
hera@172.16.0.200's password: 
Activate the web console with: systemctl enable --now cockpit.socket

Last login: Fri Mar 11 13:41:08 2022
[hera@hera ~]$ 
</code></pre><ul>
<li>Modificaremos esta regla para que accedamos por el puerto 2222 en vez del 22.</li>
</ul>
<pre><code>nft add rule inet nat prerouting iifname &quot;ens3&quot; tcp dport 2222 counter dnat ip to 172.16.0.200:22
</code></pre><pre><code>alejandrogv@AlejandroGV:~$  ssh hera@172.16.0.200 -p 2222
hera@172.16.0.200's password: 
Activate the web console with: systemctl enable --now cockpit.socket

Last login: Fri Mar 11 13:50:53 2022 from 172.16.0.1
</code></pre><ul>
<li>Solo permitiremos hacer consultas a la 192.168.202.2 desde la LAN.</li>
</ul>
<pre><code>nft add rule inet filter forward iifname &quot;ens8&quot; oifname &quot;ens3&quot; ip daddr 192.168.202.2/32 udp dport 53 ct state new,established counter accept
nft add rule inet filter forward iifname &quot;ens3&quot; oifname &quot;ens8&quot; ip saddr 192.168.202.2/32 udp sport 53 ct state established counter accept
</code></pre><pre><code>[hera@hera ~]$ dig www.google.es

; &lt;&lt;&gt;&gt; DiG 9.16.22-Debian &lt;&lt;&gt;&gt; www.google.es
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 42300
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;www.google.es.			IN	A

;; ANSWER SECTION:
www.google.es.		254	IN	A	142.250.201.67

;; Query time: 12 msec
;; SERVER: 192.168.1.1#53(192.168.1.1)
;; WHEN: Fri Mar 11 13:58:47 CET 2022
;; MSG SIZE  rcvd: 58
</code></pre><pre><code>[hera@hera ~]$ dig @1.1.1.1 www.google.es

; &lt;&lt;&gt;&gt; DiG 9.16.22-Debian &lt;&lt;&gt;&gt; @1.1.1.1 www.google.es
; (1 server found)
;; global options: +cmd
;; connection timed out; no servers could be reached
</code></pre><ul>
<li>Permitiremos que los equipos de la LAN puedan navegar por internet.</li>
</ul>
<pre><code>nft add rule inet filter forward iifname &quot;ens8&quot; oifname &quot;ens3&quot; tcp dport 80 ct state new,established counter accept
nft add rule inet filter forward iifname &quot;ens3&quot; oifname &quot;ens8&quot; tcp sport 80 ct state established counter accept
nft add rule inet filter forward iifname &quot;ens8&quot; oifname &quot;ens3&quot; tcp dport 443 ct state new,established counter accept
nft add rule inet filter forward iifname &quot;ens3&quot; oifname &quot;ens8&quot; tcp sport 443 ct state established counter accept
</code></pre><pre><code>[hera@hera ~]$ curl https://alepeteporico.github.io
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en-us&quot;&gt;
	&lt;head&gt;
		&lt;title&gt; Alepetepórico Blog &lt;/title&gt;

		&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf-8&quot;&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, maximum-scale=1&quot;&gt;
&lt;meta name=&quot;generator&quot; content=&quot;Hugo 0.80.0&quot; /&gt;




&lt;script src=&quot;https://code.jquery.com/jquery-3.1.1.min.js&quot;   integrity=&quot;sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=&quot;   crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;
</code></pre>
                </div>
                
                <div class="post-comments">
                    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "Alepetepórico" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
                
            </div>
            <footer class="footer text-center">
<p>Copyright &copy; 2022 Alepetepórico Blog -
<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>
</footer>

        </div>
    </body>
