<!DOCTYPE html>
<html>

    <head>
        <title> DNS, servidor web y base de datos &middot; Alepetepórico Blog </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.80.0" />




<script src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">


<link rel="stylesheet" href="https://alepeteporico.github.io/css/nix.css">



<link rel="shortcut icon" href="/favicon.ico">



<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">






    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
      <a class="navbar-brand" id="green-terminal" href='https://alepeteporico.github.io/'>
        blog@alepetepórico ~ $
      </a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href='https://alepeteporico.github.io/'>/home/blog</a>
        </li>
        
				
				
				<li class="dropdown">
                    
            		<a href="https://alepeteporico.github.io/apuntes">~/apuntes</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://alepeteporico.github.io/ejercicios">~/ejercicios</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://alepeteporico.github.io/problemas">~/problemas</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
            		<a href="https://alepeteporico.github.io/practicas">~/prácticas</a>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="flex-wrapper">
            <div class="container wrapper">
                <h1><a href="https://alepeteporico.github.io/practicas/server_web_bbdd_dns/">DNS, servidor web y base de datos</a></h1>
                <span class="post-date">2021-03-16 </span>
                <div class="post-content">
                    <h3 id="servidor-dns">Servidor DNS</h3>
<p>*El servidor DNS estará instalado en freston, por ello instalaremos bind en esta máquina</p>
<pre><code>    root@apolo:~# apt install bind9
</code></pre>
<p>*Configuramos el fichero &ldquo;/etc/bind/named.conf.options&rdquo; y añadimos las siguientes líneas:</p>
<pre><code>        listen-on { any; };
        allow-transfer { none; };
        recursion yes;
        allow-recursion { any; };
</code></pre><p>*Configuramos el DNS local, la DMZ y externa en el fichero de configuración /etc/bind/named.conf.local:</p>
<pre><code>view interna {
	match-clients { 10.0.1.0/24; 127.0.0.1; };
	allow-recursion { any; };

	zone &quot;alegv.gonzalonazareno.org&quot; {
		type master;
		file &quot;db.alegv.interna&quot;;
	};

        zone &quot;1.0.10.in-addr-arpa&quot; { 
                type master;
                file &quot;db.1.0.10&quot;;
        };

        zone &quot;16.172.in-addr.arpa&quot; { 
                type master;
                file &quot;db.16.172&quot;;
        };

	include &quot;/etc/bind/zones.rfc1918&quot;;
	include &quot;/etc/bind/named.conf.default-zones&quot;;
};

view dmz {
        match-clients { 172.16.0.0/16; };

        zone &quot;alegv.gonzalonazareno.org&quot; {
                type master;
                file &quot;db.alegv.dmz&quot;;
        };

        zone &quot;1.0.10.in-addr-arpa&quot; {
                type master;
                file &quot;db.1.0.10&quot;;
        };

        zone &quot;16.172.in-addr.arpa&quot; {
                type master;
                file &quot;db.16.172&quot;;
        };

        include &quot;/etc/bind/zones.rfc1918&quot;;
        include &quot;/etc/bind/named.conf.default-zones&quot;;
};

view externa {
	match-clients { 172.22.0.0/16; 192.168.202.2/32; };
	
	zone &quot;alegv.gonzalonazareno.org&quot; {
		type master;
		file &quot;db.alegv.externa&quot;;
	};

        include &quot;/etc/bind/zones.rfc1918&quot;;
        include &quot;/etc/bind/named.conf.default-zones&quot;;
};
</code></pre><ul>
<li>Y en el fichero &ldquo;/etc/bind/named.conf&rdquo; debemos comentar esta línea:</li>
</ul>
<pre><code>//include &quot;/etc/bind/named.conf.default-zones&quot;;
</code></pre><p><strong>Crearemos los archivos db, lo hacemos en la carpeta &ldquo;/var/cache/bind/&quot;</strong></p>
<h3 id="dbalegvinterna">db.alegv.interna</h3>
<pre><code>$TTL    86400
@       IN      SOA     apolo.alegv.gonzalonazareno.org. admin.alegv.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      apolo.alegv.gonzalonazareno.org.

$ORIGIN alegv.gonzalonazareno.org.

zeus	IN      A       10.0.1.1
ares	IN      A       10.0.1.101
apolo	IN      A       10.0.1.102
hera	IN      A       172.16.0.200
www     IN      CNAME   hera
bd      IN      CNAME   ares
</code></pre><h3 id="dbalegvdmz">db.alegv.dmz</h3>
<pre><code>$TTL	86400
@       IN      SOA     apolo.alegv.gonzalonazareno.org. admin.alegv.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      apolo.alegv.gonzalonazareno.org.

$ORIGIN alegv.gonzalonazareno.org.

zeus    IN      A       172.16.0.1
ares    IN      A       10.0.1.101
apolo   IN      A       10.0.1.102
hera    IN      A       172.16.0.200
www     IN      CNAME   hera   
bd      IN      CNAME   ares
</code></pre><h3 id="dbalegvexterna">db.alegv.externa</h3>
<pre><code>$TTL    86400
@       IN      SOA     zeus.alegv.gonzalonazareno.org. admin.alegv.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      zeus.alegv.gonzalonazareno.org.
@	IN	MX 10	zeus.alegv.gonzalonazareno.org.

$ORIGIN alegv.gonzalonazareno.org.

zeus	IN	A	172.22.3.191
www     IN      CNAME   zeus   
bd      IN      CNAME   zeus
</code></pre><p><strong>Ahora crearemos los archivos de las resoluciones inversas en la misma ruta</strong></p>
<h3 id="db1010">db.1.0.10</h3>
<pre><code>$TTL    86400
@       IN      SOA     apolo.alegv.gonzalonazareno.org. admin.alegv.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      apolo.alegv.gonzalonazareno.org.

$ORIGIN 1.0.10.in-addr.arpa.

1	IN	PTR	zeus.alegv.gonzalonazareno.org.
101	IN	PTR	ares.alegv.gonzalonazareno.org.
102	IN	PTR	apolo.alegv.gonzalonazareno.org.
</code></pre><h3 id="db16172">db.16.172</h3>
<pre><code>$TTL    86400
@       IN      SOA     apolo.alegv.gonzalonazareno.org. admin.alegv.gonzalonazareno.org. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      apolo.alegv.gonzalonazareno.org.

$ORIGIN 16.172.in-addr.arpa.

0.200	IN	PTR	hera.alegv.gonzalonazareno.org.
0.1	IN	PTR	zeus.alegv.gonzalonazareno.org.
</code></pre><ul>
<li>Si quisieramos asegurarnos de que no tenemos ningún error de sintáxis podemos usar esto:</li>
</ul>
<pre><code>root@freston:/var/cache/bind# named-checkconf
</code></pre><ul>
<li>IPV6 da conflictos, así que podemos deshabilitarlo en el fichero &ldquo;/etc/default/bind9&rdquo;</li>
</ul>
<pre><code># run resolvconf?
RESOLVCONF=yes

# startup options for the server
OPTIONS=&quot;-4 -u bind&quot;
</code></pre><ul>
<li>Reiniciamos el servicio de DNS</li>
</ul>
<pre><code>debian@apolo:~$ sudo systemctl restart bind9

debian@apolo:~$ sudo systemctl status bind9
* named.service - BIND Domain Name Server
     Loaded: loaded (/lib/systemd/system/named.service; enabled; vendor preset: enabled)
     Active: active (running) since Mon 2022-01-31 13:14:39 CET; 10s ago
       Docs: man:named(8)
   Main PID: 1688 (named)
      Tasks: 4 (limit: 529)
     Memory: 18.6M
        CPU: 302ms
     CGroup: /system.slice/named.service
             `-1688 /usr/sbin/named -f -u bind

Jan 31 13:14:40 apolo named[1688]: network unreachable resolving './DNSKEY/IN': 2001:7fe::53#53
Jan 31 13:14:40 apolo named[1688]: network unreachable resolving './DNSKEY/IN': 2001:503:c27::2:30#53
Jan 31 13:14:40 apolo named[1688]: network unreachable resolving './DNSKEY/IN': 2001:503:ba3e::2:30#53
Jan 31 13:14:40 apolo named[1688]: network unreachable resolving './DNSKEY/IN': 2001:500:12::d0d#53
Jan 31 13:14:40 apolo named[1688]: managed-keys-zone/interna: Key 20326 for zone . is now trusted (accep&gt;
Jan 31 13:14:40 apolo named[1688]: managed-keys-zone/dmz: Key 20326 for zone . is now trusted (acceptanc&gt;
Jan 31 13:14:40 apolo named[1688]: resolver priming query complete
Jan 31 13:14:40 apolo named[1688]: resolver priming query complete
Jan 31 13:14:40 apolo named[1688]: managed-keys-zone/externa: Key 20326 for zone . is now trusted (accep&gt;
Jan 31 13:14:40 apolo named[1688]: resolver priming query complete
</code></pre><ul>
<li>Vamos a hacer las comprobaciones necesarias en cada máquina:</li>
</ul>
<h3 id="dulcinea">Dulcinea</h3>
<pre><code>    debian@dulcinea:~$ dig +short @10.0.1.9 dulcinea.alegv.gonzalonazareno.org
    10.0.1.8
    debian@dulcinea:~$ dig +short @10.0.1.9 freston.alegv.gonzalonazareno.org
    10.0.1.9
    debian@dulcinea:~$ dig +short @10.0.1.9 quijote.alegv.gonzalonazareno.org
    10.0.2.5
    debian@dulcinea:~$ dig +short @10.0.1.9 sancho.alegv.gonzalonazareno.org
    10.0.1.3

    debian@dulcinea:~$ dig +short @10.0.1.9 bd.alegv.gonzalonazareno.org
    sancho.alegv.gonzalonazareno.org.
    10.0.1.3
    debian@dulcinea:~$ dig +short @10.0.1.9 www.alegv.gonzalonazareno.org
    quijote.alegv.gonzalonazareno.org.
    10.0.2.2
</code></pre>
<h3 id="quijote">Quijote</h3>
<pre><code>    [centos@quijote ~]$ dig +short @10.0.1.9 -x 10.0.2.5
    quijote.2.0.10.in-addr.arpa.
    [centos@quijote ~]$ dig +short @10.0.1.9 -x 10.0.2.10
    dulcinea.2.0.10.in-addr.arpa.
</code></pre>
<h3 id="sancho">Sancho</h3>
<pre><code>    ubuntu@sancho:~$ dig +short @10.0.1.9 dulcinea.alegv.gonzalonazareno.org
    10.0.1.8
    ubuntu@sancho:~$ dig +short @10.0.1.9 freston.alegv.gonzalonazareno.org
    10.0.1.9
</code></pre>
<h3 id="freston">Freston</h3>
<pre><code>    debian@freston:~$ dig +short @localhost -x 10.0.1.3
    sancho.1.0.10.in-addr.arpa.

    debian@freston:~$ dig +short @localhost -x 10.0.1.8
    dulcinea.1.0.10.in-addr.arpa.
</code></pre>
<h3 id="desde-fuera">Desde fuera:</h3>
<pre><code>alejandrogv@AlejandroGV:~$ dig alegv.gonzalonazareno.org

; &lt;&lt;&gt;&gt; DiG 9.16.22-Debian &lt;&lt;&gt;&gt; alegv.gonzalonazareno.org
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 12856
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: d14809270130ee359e88c61961f8ef40775f5cc6025b334e (good)
;; QUESTION SECTION:
;alegv.gonzalonazareno.org.	IN	A

;; AUTHORITY SECTION:
alegv.gonzalonazareno.org. 10748 IN	SOA	zeus.alegv.gonzalonazareno.org. admin.alegv.gonzalonazareno.org. 1 604800 86400 2419200 86400

;; Query time: 0 msec
;; SERVER: 192.168.202.2#53(192.168.202.2)
;; WHEN: Tue Feb 01 09:28:48 CET 2022
;; MSG SIZE  rcvd: 129

alejandrogv@AlejandroGV:~$ dig +short zeus.alegv.gonzalonazareno.org
172.22.3.191

alejandrogv@AlejandroGV:~$ dig +short www.alegv.gonzalonazareno.org
zeus.alegv.gonzalonazareno.org.
172.22.3.191
</code></pre><h3 id="servidor-web">Servidor web</h3>
<p><strong>Tenemos el servidor DNS, continuemos con el servidor web, este servidor estará situado en Quijote, será un servidor apache capaz de ejecutar php. Lo primero que deberemos hacer es instalar el servidor apache y php (el paquete de apache en CentOS se llama httpd)</strong></p>
<pre><code>    [centos@quijote ~]$ sudo dnf install httpd php php-fpm
</code></pre>
<p><strong>Tenemos que iniciar y habilitar los servicios httpd y php</strong></p>
<pre><code>    [centos@quijote ~]$ sudo systemctl start php-fpm httpd
    [centos@quijote ~]$ sudo systemctl enable php-fpm httpd
    Created symlink /etc/systemd/system/multi-user.target.wants/php-fpm.service → /usr/lib/systemd/system/php-fpm.service.
    Created symlink /etc/systemd/system/multi-user.target.wants/httpd.service → /usr/lib/systemd/system/httpd.service.
</code></pre>
<p><strong>Para que podamos acceder debemos habilitar en el firewall los puertos 443, 80 y 53</strong></p>
<pre><code>    [centos@quijote ~]$ sudo firewall-cmd --permanent --add-port=443/tcp
    success
    [centos@quijote ~]$ sudo firewall-cmd --permanent --add-port=80/tcp
    success
    [centos@quijote ~]$ sudo firewall-cmd --permanent --add-port=53/udp
    success
</code></pre>
<p><strong>Para guardarlas debemos hacer un reload y comprobamos las reglas que tenemos:</strong></p>
<pre><code>    [centos@quijote ~]$ sudo firewall-cmd --reload
    success
    [centos@quijote ~]$ sudo firewall-cmd --list-all
    public (active)
      target: default
      icmp-block-inversion: no
      interfaces: eth0
      sources: 
      services: dhcpv6-client ssh
      ports: 443/tcp 80/tcp 53/udp
      protocols: 
      masquerade: no
      forward-ports: 
      source-ports: 
      icmp-blocks: 
      rich rules:
</code></pre>
<p><strong>En CentOS los directorios sites-avaiable y sites-enabled no se crean por defecto, los crearemos nosotros:</strong></p>
<pre><code>    [centos@quijote ~]$ sudo mkdir /etc/httpd/sites-enabled /etc/httpd/sites-available
</code></pre>
<p><strong>Ahora entraremos al fichero de configuración &ldquo;/etc/httpd/conf/httpd.conf&rdquo; para añadir sites-avaiable como nueva ruta comentando la última línea y añadiendo otra</strong></p>
<pre><code>    #IncludeOptional conf.d/*.conf
    IncludeOptional	sites-enabled/*.conf
</code></pre>
<p><strong>Directamente pasaremos a la configuración de un virtualhost</strong></p>
<pre><code>    [centos@quijote ~]$ cat /etc/httpd/sites-available/pagina.conf
    &lt;VirtualHost *:80&gt;
        ServerName www.alegv.gonzalonazareno.org
        DocumentRoot /var/www/alegv

        &lt;Directory /var/www/alegv/&gt;
            Options FollowSymLinks
            AllowOverride All
            Order deny,allow
            Allow from all

            &lt;FilesMatch &quot;\.php&quot;&gt;
                    SetHandler &quot;proxy:unix:/run/php-fpm/www.sock|fcgi://localhost&quot;
            &lt;/FilesMatch&gt;

        &lt;/Directory&gt;

        ErrorLog /var/www/alegv/log/error.log
        CustomLog /var/www/alegv/log/requests.log combined
    &lt;/VirtualHost&gt;
</code></pre>
<p><strong>Creamos el vínculo en sites-enabled y las carpetas necesarias en &ldquo;/var/www/&quot;</strong></p>
<pre><code>    [centos@quijote sites-available]$ sudo ln -s pagina.conf ../sites-enabled/
    [centos@quijote ~]$ sudo mkdir -p /var/www/alegv/log
</code></pre>
<p><strong>Selinux nos dará problemas con los nuevos directorios, por ello debemos ejecutar los siguientes comandos y reiniciar el servicio httpd</strong></p>
<pre><code>    [centos@quijote ~]$ sudo semanage fcontext -a -t httpd_log_t &quot;/var/www/alegv/log(/.*)?&quot;
    [root@quijote ~]# sudo restorecon -R -v /var/www/alegv/log
    [centos@quijote sites-available]$ sudo setsebool -P httpd_unified 1

    [centos@quijote sites-available]$ sudo systemctl restart httpd
</code></pre>
<p><strong>Creamos el fichero info.php</strong></p>
<pre><code>    [centos@quijote ~]$ cat /var/www/alegv/info.php 
    &lt;?php phpinfo(); ?&gt;
</code></pre>
<p><strong>Comprobemos que funciona</strong></p>
<p><img src="/dns_web_bbdd/1.png" alt="info"></p>
<h3 id="servidor-base-de-datos">Servidor Base de datos.</h3>
<p><strong>Usaremos el gestor mariadb</strong></p>
<pre><code>    ubuntu@sancho:~$ sudo apt install mariadb-server
</code></pre>
<p><strong>Y una vez instalado debemos configurarlo para permitir el uso de usuarios remoto accediendo al fichero <code>/etc/mysql/mariadb.conf.d/50-server.cnf</code> y modificando la línea <code>bind-address</code> tal como aparece a continuación</strong></p>
<pre><code>    bind-address            = 0.0.0.0
</code></pre>
<p><strong>Ahora vamos a entrar y crear un usuario que usaremos remotamente.</strong></p>
<pre><code>    ubuntu@sancho:~$ sudo mysql -u root -p

    MariaDB [(none)]&gt; CREATE USER 'ale'@'10.0.2.5' IDENTIFIED BY 'ale';
    Query OK, 0 rows affected (0.009 sec)
</code></pre>
<p><strong>Crearemos una base de datos y daremos a nuestro usuario remoto privilegios sobre ella</strong></p>
<pre><code>    MariaDB [(none)]&gt; CREATE DATABASE prueba;
    Query OK, 1 row affected (0.010 sec)

    MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON *.* TO 'ale'@'10.0.2.5'
        -&gt; ;
    Query OK, 0 rows affected (0.001 sec)
</code></pre>
<p><strong>Ahora vayamos a centos, y lo primero que haremos será instalar el cliente de mariadb</strong></p>
<pre><code>    [centos@quijote ~]$ sudo dnf install mariadb
</code></pre>
<p><strong>Y procedemos a acceder al servidor mariadb con las credenciales que usamos anteriormente</strong></p>
<pre><code>    [root@quijote ~]# mysql -u ale -p -h bd.alegv.gonzalonazareno.org
    Enter password: 
    Welcome to the MariaDB monitor.  Commands end with ; or \g.
    Your MariaDB connection id is 37
    Server version: 10.3.29-MariaDB-0ubuntu0.20.04.1 Ubuntu 20.04
    
    Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.
    
    Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
    
    MariaDB [(none)]&gt;
</code></pre>
<p><strong>Vamos a comprobar que funciona simplemente listando las bases de datos que tenemos</strong></p>
<pre><code>    MariaDB [(none)]&gt; SHOW DATABASES;
    +--------------------+
    | Database           |
    +--------------------+
    | information_schema |
    | mysql              |
    | performance_schema |
    | prueba             |
    +--------------------+
    4 rows in set (0.034 sec)</code></pre>

                </div>
                
                <div class="post-comments">
                    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "Alepetepórico" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
                
            </div>
            <footer class="footer text-center">
<p>Copyright &copy; 2022 Alepetepórico Blog -
<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>
</footer>

        </div>
    </body>
